<!--
  * QOLAE New Starter Compliance Portal
  * New starter submission form for compliance documents
  * Organized by Location Block Protocol
  * Author: Atlas Agent
  * Date: October 14, 2025
  *
  * WORKFLOW STEPS:
  * 1. New starter login with PIN (from email invitation)
  * 2. Application Form (personal details, address, emergency contact)
  * 3. Identity Documents Upload (passport, driver's license, birth certificate)
  * 4. Proof of Address Upload (utility bill or bank statement)
  * 5. Professional Reference Details
  * 6. Character Reference Details
  * 7. Review & Submit
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Starter Compliance - QOLAE</title>

<!-- ========================================== -->
<!-- LOCATION BLOCK 0: ALL CSS STYLES -->
<!-- ========================================== -->
    <style>
        /* ===== RESET & BASE STYLES ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* ===== HEADER STYLES ===== */
        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: bold;
            color: #693382;
            font-family: Baskerville, "Baskerville Old Face", serif;
            margin-bottom: 8px;
        }

        .header p {
            color: #6b7280;
            font-size: 14px;
        }

        /* ===== PROGRESS BAR ===== */
        .progress-container {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #059669);
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-text {
            text-align: center;
            font-size: 14px;
            color: #6b7280;
            font-weight: 600;
        }

        /* ===== COMPLIANCE CARD ===== */
        .compliance-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            padding: 32px;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: bold;
            color: #374151;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .section-subtitle {
            color: #6b7280;
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* ===== FORM STYLES ===== */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 14px;
        }

        .form-label .required {
            color: #ef4444;
        }

        .form-input, .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s, box-shadow 0.2s;
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .help-text {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
            font-style: italic;
        }

        /* ===== FILE UPLOAD STYLES ===== */
        .file-upload-section {
            margin-bottom: 24px;
            padding: 20px;
            background: #f9fafb;
            border-radius: 8px;
        }

        .file-upload-section h4 {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
        }

        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 24px;
            text-align: center;
            background: white;
            transition: all 0.2s;
            cursor: pointer;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #f3f4f6;
        }

        .file-upload-area.dragover {
            border-color: #10b981;
            background: #d1fae5;
        }

        .file-upload-icon {
            font-size: 36px;
            margin-bottom: 8px;
        }

        .file-upload-text {
            font-size: 14px;
            color: #374151;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .file-upload-hint {
            font-size: 12px;
            color: #6b7280;
        }

        .file-input {
            display: none;
        }

        .file-list {
            margin-top: 12px;
        }

        .file-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: #f0fdf4;
            border: 1px solid #10b981;
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .file-item-icon {
            font-size: 24px;
        }

        .file-item-details {
            flex: 1;
        }

        .file-item-name {
            font-weight: 600;
            color: #065f46;
            font-size: 14px;
        }

        .file-item-size {
            font-size: 12px;
            color: #047857;
        }

        .file-remove-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: background 0.2s;
        }

        .file-remove-btn:hover {
            background: #dc2626;
        }

        /* ===== BUTTON STYLES ===== */
        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.3);
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover {
            background: #4b5563;
        }

        .btn-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .btn-next {
            flex: 1;
            justify-content: center;
            font-size: 16px;
            padding: 14px;
        }

        /* ===== MESSAGE STYLES ===== */
        .message {
            display: none;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 24px;
            text-align: center;
            animation: slideDown 0.3s ease-out;
        }

        .message.visible {
            display: block;
        }

        .success-message {
            background: #d1fae5;
            border: 1px solid #10b981;
            color: #065f46;
        }

        .error-message {
            background: #fee2e2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== REVIEW SECTION ===== */
        .review-section {
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .review-section h3 {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 16px;
        }

        .review-item {
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .review-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .review-label {
            font-weight: 600;
            color: #6b7280;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .review-value {
            color: #374151;
            font-size: 14px;
        }

        /* ===== STEP VISIBILITY ===== */
        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* ===== FOOTER ===== */
        .footer {
            text-align: center;
            color: white;
            font-size: 12px;
            margin-top: 32px;
            padding: 20px;
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }

            .btn-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">

<!-- ========================================== -->
<!-- LOCATION BLOCK 1: HEADER -->
<!-- ========================================== -->
        <div class="header">
            <h1>=d New Starter Compliance Portal</h1>
            <p>Welcome to QOLAE! Complete your compliance to start your journey with us</p>
        </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 2: PROGRESS TRACKER -->
<!-- ========================================== -->
        <div class="progress-container">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">Step 1 of 6</div>
        </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 3: MESSAGES -->
<!-- ========================================== -->
        <div id="successMessage" class="message success-message">
            <strong> Compliance Submitted Successfully!</strong>
            <p style="margin-top: 8px;">Your submission will be reviewed by our HR team. You'll be notified once approved.</p>
        </div>

        <div id="errorMessage" class="message error-message">
            <strong>L Submission Failed</strong>
            <p id="errorText" style="margin-top: 8px;"></p>
        </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 4: STEP 1 - APPLICATION FORM -->
<!-- ========================================== -->
        <div id="step1" class="step-content active">
            <div class="compliance-card">
                <h2 class="section-title">=À Step 1: Application Form</h2>
                <p class="section-subtitle">Please provide your personal details</p>

                <form id="applicationForm">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Address Line 1 <span class="required">*</span></label>
                            <input type="text" id="addressLine1" class="form-input" placeholder="e.g., 123 Main Street" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Address Line 2</label>
                            <input type="text" id="addressLine2" class="form-input" placeholder="Apartment, suite, etc.">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">City <span class="required">*</span></label>
                            <input type="text" id="city" class="form-input" placeholder="e.g., Edinburgh" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Postcode <span class="required">*</span></label>
                            <input type="text" id="postcode" class="form-input" placeholder="e.g., EH1 1AA" required>
                        </div>
                    </div>

                    <h3 style="font-size: 16px; font-weight: 600; color: #374151; margin: 24px 0 16px;">Emergency Contact</h3>

                    <div class="form-group">
                        <label class="form-label">Full Name <span class="required">*</span></label>
                        <input type="text" id="emergencyContactName" class="form-input" placeholder="e.g., Jane Smith" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Phone Number <span class="required">*</span></label>
                            <input type="tel" id="emergencyContactPhone" class="form-input" placeholder="e.g., +44 7700 900000" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Relationship <span class="required">*</span></label>
                            <input type="text" id="emergencyContactRelationship" class="form-input" placeholder="e.g., Spouse, Parent" required>
                        </div>
                    </div>

                    <div class="btn-actions">
                        <button type="button" class="btn btn-primary btn-next" id="step1NextBtn">
                            Next: Identity Documents í
                        </button>
                    </div>
                </form>
            </div>
        </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 5: STEP 2 - IDENTITY DOCUMENTS -->
<!-- ========================================== -->
        <div id="step2" class="step-content">
            <div class="compliance-card">
                <h2 class="section-title">>™ Step 2: Identity Documents</h2>
                <p class="section-subtitle">Upload passport or driver's license + birth certificate</p>

                <div class="file-upload-section">
                    <h4>=ƒ Upload Documents (PDF, JPG, PNG - max 5MB each)</h4>
                    <div class="file-upload-area" id="identityUploadArea">
                        <div class="file-upload-icon">=¡</div>
                        <div class="file-upload-text">Click to upload or drag & drop</div>
                        <div class="file-upload-hint">Required: Passport/Driver's License + Birth Certificate</div>
                    </div>
                    <input type="file" id="identityFileInput" class="file-input" accept=".pdf,.jpg,.jpeg,.png" multiple>
                    <div class="file-list" id="identityFileList"></div>
                </div>

                <div class="btn-actions">
                    <button type="button" class="btn btn-secondary" id="step2BackBtn">ê Back</button>
                    <button type="button" class="btn btn-primary btn-next" id="step2NextBtn" disabled>
                        Next: Proof of Address í
                    </button>
                </div>
            </div>
        </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 6: STEP 3 - PROOF OF ADDRESS -->
<!-- ========================================== -->
        <div id="step3" class="step-content">
            <div class="compliance-card">
                <h2 class="section-title"><‡ Step 3: Proof of Address</h2>
                <p class="section-subtitle">Upload recent utility bill or bank statement (dated within 3 months)</p>

                <div class="file-upload-section">
                    <h4>=ƒ Upload Documents (PDF, JPG, PNG - max 5MB each)</h4>
                    <div class="file-upload-area" id="utilityUploadArea">
                        <div class="file-upload-icon">=¡</div>
                        <div class="file-upload-text">Click to upload or drag & drop</div>
                        <div class="file-upload-hint">Required: Utility bill or bank statement (recent)</div>
                    </div>
                    <input type="file" id="utilityFileInput" class="file-input" accept=".pdf,.jpg,.jpeg,.png" multiple>
                    <div class="file-list" id="utilityFileList"></div>
                </div>

                <div class="btn-actions">
                    <button type="button" class="btn btn-secondary" id="step3BackBtn">ê Back</button>
                    <button type="button" class="btn btn-primary btn-next" id="step3NextBtn" disabled>
                        Next: Professional Reference í
                    </button>
                </div>
            </div>
        </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 7: STEP 4 - PROFESSIONAL REFERENCE -->
<!-- ========================================== -->
        <div id="step4" class="step-content">
            <div class="compliance-card">
                <h2 class="section-title">=T Step 4: Professional Reference</h2>
                <p class="section-subtitle">Provide details for a professional referee</p>

                <form id="professionalRefForm">
                    <div class="form-group">
                        <label class="form-label">Full Name <span class="required">*</span></label>
                        <input type="text" id="profRefName" class="form-input" placeholder="e.g., Dr. Sarah Johnson" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Job Title <span class="required">*</span></label>
                            <input type="text" id="profRefTitle" class="form-input" placeholder="e.g., Senior Manager" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Organisation <span class="required">*</span></label>
                            <input type="text" id="profRefOrganisation" class="form-input" placeholder="e.g., ABC Company Ltd" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email <span class="required">*</span></label>
                            <input type="email" id="profRefEmail" class="form-input" placeholder="e.g., sarah@company.com" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone <span class="required">*</span></label>
                            <input type="tel" id="profRefPhone" class="form-input" placeholder="e.g., +44 7700 900000" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Relationship <span class="required">*</span></label>
                        <textarea id="profRefRelationship" class="form-textarea" placeholder="e.g., Sarah was my line manager at ABC Company from 2020-2023" required></textarea>
                    </div>

                    <div class="btn-actions">
                        <button type="button" class="btn btn-secondary" id="step4BackBtn">ê Back</button>
                        <button type="button" class="btn btn-primary btn-next" id="step4NextBtn">
                            Next: Character Reference í
                        </button>
                    </div>
                </form>
            </div>
        </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 8: STEP 5 - CHARACTER REFERENCE -->
<!-- ========================================== -->
        <div id="step5" class="step-content">
            <div class="compliance-card">
                <h2 class="section-title">=d Step 5: Character Reference</h2>
                <p class="section-subtitle">Provide details for a character referee</p>

                <form id="characterRefForm">
                    <div class="form-group">
                        <label class="form-label">Full Name <span class="required">*</span></label>
                        <input type="text" id="charRefName" class="form-input" placeholder="e.g., Prof. John Smith" required>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Relationship <span class="required">*</span></label>
                            <input type="text" id="charRefRelationship" class="form-input" placeholder="e.g., Academic supervisor" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Known Duration <span class="required">*</span></label>
                            <input type="text" id="charRefKnownDuration" class="form-input" placeholder="e.g., 5 years" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Email <span class="required">*</span></label>
                            <input type="email" id="charRefEmail" class="form-input" placeholder="e.g., john@university.ac.uk" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Phone <span class="required">*</span></label>
                            <input type="tel" id="charRefPhone" class="form-input" placeholder="e.g., +44 7700 900001" required>
                        </div>
                    </div>

                    <div class="btn-actions">
                        <button type="button" class="btn btn-secondary" id="step5BackBtn">ê Back</button>
                        <button type="button" class="btn btn-primary btn-next" id="step5NextBtn">
                            Next: Review & Submit í
                        </button>
                    </div>
                </form>
            </div>
        </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 9: STEP 6 - REVIEW & SUBMIT -->
<!-- ========================================== -->
        <div id="step6" class="step-content">
            <div class="compliance-card">
                <h2 class="section-title"> Step 6: Review & Submit</h2>
                <p class="section-subtitle">Please review all information before submitting</p>

                <div class="review-section">
                    <h3>=À Application Details</h3>
                    <div class="review-item">
                        <div class="review-label">Address</div>
                        <div class="review-value" id="reviewAddress"></div>
                    </div>
                    <div class="review-item">
                        <div class="review-label">Emergency Contact</div>
                        <div class="review-value" id="reviewEmergencyContact"></div>
                    </div>
                </div>

                <div class="review-section">
                    <h3>>™ Documents Uploaded</h3>
                    <div class="review-item">
                        <div class="review-label">Identity Documents</div>
                        <div class="review-value" id="reviewIdentityDocs"></div>
                    </div>
                    <div class="review-item">
                        <div class="review-label">Proof of Address</div>
                        <div class="review-value" id="reviewUtilityDocs"></div>
                    </div>
                </div>

                <div class="review-section">
                    <h3>=T Professional Reference</h3>
                    <div class="review-item">
                        <div class="review-label">Name & Organisation</div>
                        <div class="review-value" id="reviewProfRef"></div>
                    </div>
                </div>

                <div class="review-section">
                    <h3>=d Character Reference</h3>
                    <div class="review-item">
                        <div class="review-label">Name & Relationship</div>
                        <div class="review-value" id="reviewCharRef"></div>
                    </div>
                </div>

                <div class="btn-actions">
                    <button type="button" class="btn btn-secondary" id="step6BackBtn">ê Back</button>
                    <button type="button" class="btn btn-primary btn-next" id="submitBtn">
                        =Ä Submit Compliance
                    </button>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>QOLAE HR Compliance Dashboard</p>
            <p>Your information is secure and GDPR-compliant</p>
        </div>
    </div>

<!-- ========================================== -->
<!-- LOCATION BLOCK 10: JAVASCRIPT - FORM LOGIC -->
<!-- ========================================== -->
    <script>
        // Get PIN from URL or server
        const urlParams = new URLSearchParams(window.location.search);
        const newStarterPin = urlParams.get('pin') || '<%= typeof pin !== "undefined" ? pin : "" %>';

        let currentStep = 1;
        let formData = {
            identityFiles: [],
            utilityFiles: []
        };

        // Progress tracking
        function updateProgress(step) {
            const progress = (step / 6) * 100;
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = `Step ${step} of 6`;
        }

        // Navigation
        function showStep(step) {
            document.querySelectorAll('.step-content').forEach(s => s.classList.remove('active'));
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
            updateProgress(step);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // File upload handlers
        function setupFileUpload(areaId, inputId, listId, fileArray) {
            const area = document.getElementById(areaId);
            const input = document.getElementById(inputId);
            const list = document.getElementById(listId);

            area.addEventListener('click', () => input.click());
            area.addEventListener('dragover', (e) => { e.preventDefault(); area.classList.add('dragover'); });
            area.addEventListener('dragleave', () => area.classList.remove('dragover'));
            area.addEventListener('drop', (e) => {
                e.preventDefault();
                area.classList.remove('dragover');
                handleFiles(Array.from(e.dataTransfer.files), fileArray, list);
            });

            input.addEventListener('change', (e) => {
                handleFiles(Array.from(e.target.files), fileArray, list);
            });
        }

        function handleFiles(files, fileArray, listElement) {
            files.forEach(file => {
                if (file.size > 5 * 1024 * 1024) {
                    alert(`${file.name} exceeds 5MB limit`);
                    return;
                }
                fileArray.push(file);
            });
            renderFileList(fileArray, listElement);
        }

        function renderFileList(fileArray, listElement) {
            listElement.innerHTML = fileArray.map((file, index) => `
                <div class="file-item">
                    <div class="file-item-icon">=ƒ</div>
                    <div class="file-item-details">
                        <div class="file-item-name">${file.name}</div>
                        <div class="file-item-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button type="button" class="file-remove-btn" onclick="removeFile(${index}, '${listElement.id}')">Remove</button>
                </div>
            `).join('');

            // Enable next button if files uploaded
            if (fileArray.length > 0) {
                const stepNum = listElement.id.includes('identity') ? 2 : 3;
                document.getElementById(`step${stepNum}NextBtn`).disabled = false;
            }
        }

        function removeFile(index, listId) {
            const fileArray = listId.includes('identity') ? formData.identityFiles : formData.utilityFiles;
            fileArray.splice(index, 1);
            const listElement = document.getElementById(listId);
            renderFileList(fileArray, listElement);
        }

        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // Step navigation
        document.getElementById('step1NextBtn').addEventListener('click', () => {
            const form = document.getElementById('applicationForm');
            if (form.checkValidity()) {
                formData.application = {
                    addressLine1: document.getElementById('addressLine1').value,
                    addressLine2: document.getElementById('addressLine2').value,
                    city: document.getElementById('city').value,
                    postcode: document.getElementById('postcode').value,
                    emergencyContactName: document.getElementById('emergencyContactName').value,
                    emergencyContactPhone: document.getElementById('emergencyContactPhone').value,
                    emergencyContactRelationship: document.getElementById('emergencyContactRelationship').value
                };
                showStep(2);
            } else {
                form.reportValidity();
            }
        });

        document.getElementById('step2BackBtn').addEventListener('click', () => showStep(1));
        document.getElementById('step2NextBtn').addEventListener('click', () => showStep(3));

        document.getElementById('step3BackBtn').addEventListener('click', () => showStep(2));
        document.getElementById('step3NextBtn').addEventListener('click', () => showStep(4));

        document.getElementById('step4BackBtn').addEventListener('click', () => showStep(3));
        document.getElementById('step4NextBtn').addEventListener('click', () => {
            const form = document.getElementById('professionalRefForm');
            if (form.checkValidity()) {
                formData.professionalReference = {
                    name: document.getElementById('profRefName').value,
                    title: document.getElementById('profRefTitle').value,
                    organisation: document.getElementById('profRefOrganisation').value,
                    email: document.getElementById('profRefEmail').value,
                    phone: document.getElementById('profRefPhone').value,
                    relationship: document.getElementById('profRefRelationship').value
                };
                showStep(5);
            } else {
                form.reportValidity();
            }
        });

        document.getElementById('step5BackBtn').addEventListener('click', () => showStep(4));
        document.getElementById('step5NextBtn').addEventListener('click', () => {
            const form = document.getElementById('characterRefForm');
            if (form.checkValidity()) {
                formData.characterReference = {
                    name: document.getElementById('charRefName').value,
                    relationship: document.getElementById('charRefRelationship').value,
                    email: document.getElementById('charRefEmail').value,
                    phone: document.getElementById('charRefPhone').value,
                    knownDuration: document.getElementById('charRefKnownDuration').value
                };
                populateReview();
                showStep(6);
            } else {
                form.reportValidity();
            }
        });

        document.getElementById('step6BackBtn').addEventListener('click', () => showStep(5));

        // Review population
        function populateReview() {
            document.getElementById('reviewAddress').textContent =
                `${formData.application.addressLine1}, ${formData.application.city} ${formData.application.postcode}`;
            document.getElementById('reviewEmergencyContact').textContent =
                `${formData.application.emergencyContactName} (${formData.application.emergencyContactRelationship}) - ${formData.application.emergencyContactPhone}`;
            document.getElementById('reviewIdentityDocs').textContent =
                `${formData.identityFiles.length} file(s) uploaded`;
            document.getElementById('reviewUtilityDocs').textContent =
                `${formData.utilityFiles.length} file(s) uploaded`;
            document.getElementById('reviewProfRef').textContent =
                `${formData.professionalReference.name} - ${formData.professionalReference.organisation}`;
            document.getElementById('reviewCharRef').textContent =
                `${formData.characterReference.name} (${formData.characterReference.relationship})`;
        }

        // Submit
        document.getElementById('submitBtn').addEventListener('click', async () => {
            try {
                const submitBtn = document.getElementById('submitBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'Û Submitting...';

                const submitData = new FormData();
                submitData.append('pin', newStarterPin);

                // Application data
                Object.keys(formData.application).forEach(key => {
                    submitData.append(key, formData.application[key]);
                });

                // Files
                formData.identityFiles.forEach(file => submitData.append('identityDocuments', file));
                formData.utilityFiles.forEach(file => submitData.append('utilityBills', file));

                // References
                Object.keys(formData.professionalReference).forEach(key => {
                    submitData.append(`professionalReference${key.charAt(0).toUpperCase() + key.slice(1)}`, formData.professionalReference[key]);
                });
                Object.keys(formData.characterReference).forEach(key => {
                    submitData.append(`characterReference${key.charAt(0).toUpperCase() + key.slice(1)}`, formData.characterReference[key]);
                });

                const response = await fetch('/api/new-starter/submit-compliance', {
                    method: 'POST',
                    body: submitData
                });

                const data = await response.json();

                if (data.success) {
                    document.getElementById('successMessage').classList.add('visible');
                    document.querySelectorAll('.step-content').forEach(s => s.style.display = 'none');
                    setTimeout(() => window.location.href = '/new-starter-dashboard', 3000);
                } else {
                    throw new Error(data.error || 'Submission failed');
                }

            } catch (error) {
                console.error('Submission error:', error);
                document.getElementById('errorText').textContent = error.message;
                document.getElementById('errorMessage').classList.add('visible');
                document.getElementById('submitBtn').disabled = false;
                document.getElementById('submitBtn').textContent = '=Ä Submit Compliance';
            }
        });

        // Initialize file uploads
        setupFileUpload('identityUploadArea', 'identityFileInput', 'identityFileList', formData.identityFiles);
        setupFileUpload('utilityUploadArea', 'utilityFileInput', 'utilityFileList', formData.utilityFiles);

        window.addEventListener('DOMContentLoaded', () => {
            console.log('=d New Starter Compliance Portal initialized');
            console.log('PIN:', newStarterPin);
        });
    </script>
</body>
</html>
